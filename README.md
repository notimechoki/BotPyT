# Telegram Bot (User / Moderator / Admin)

Проект — телеграм-бот с тремя отдельными ботами и общей базой данных.

**Зачем 3 бота:**
- чтобы чётко разделить доступы (пользователи не видят админку),
- чтобы модерация и администрация работали независимо,
- чтобы упростить поддержку и развитие (аналитика/фичи отдельно).

---

## Содержание
- [Функционал](#функционал)
- [Архитектура](#архитектура)
- [Структура проекта](#структура-проекта)
- [Роли и доступы](#роли-и-доступы)
- [Как работает тотализатор и коэффициенты](#как-работает-тотализатор-и-коэффициенты)
- [Установка и запуск Linux (Fedora/Ubuntu)](#установка-и-запуск-linux-fedoraubuntu)
- [Установка и запуск Windows](#установка-и-запуск-windows)
- [Тестовый сценарий проверки](#тестовый-сценарий-проверки)
- [Известные ограничения / баги](#известные-ограничения--баги)

---

## Функционал

### User Bot (пользовательский)
- ✅ регистрация по `/start`
- ✅ стартовый баланс **1000 монет**
- ✅ просмотр активных событий
- ✅ ставка на выбранный исход
- ✅ динамический коэффициент
- ✅ просмотр баланса
- ✅ активные ставки
- ✅ история ставок (выигрыш/проигрыш)
- ✅ предложение события (уходит в модерацию)
- ✅ поддержка через тикеты (диалог пользователь ↔ модератор)
- ✅ уведомления пользователю по итогам события и по ответам поддержки

### Mod Bot (модерация)
- ✅ просмотр предложений событий
- ✅ одобрение / отклонение предложений
- ✅ создание события на основе предложения (после approve)
- ✅ просмотр тикетов поддержки
- ✅ переписка с пользователем внутри тикета
- ✅ закрытие тикета

### Admin Bot (админка)
- ✅ создание событий (в т.ч. комиссия)
- ✅ закрытие событий (выбор победителя)
- ✅ автоматическое подведение итогов и выплаты
- ✅ история событий (включая победителя / финальный кэф / источник — вручную или из предложения)
- ✅ история предложений (кто отправил, кто одобрил, причина отклонения)
- ✅ история тикетов (кто создал, статус, полный диалог)
- ✅ поиск пользователя по `telegram_id` или `@username`
- ✅ просмотр ставок пользователя (что/когда ставил, выигрыш)
- ✅ управление ролями (user/moderator/admin)
- ✅ управление балансом пользователя (+/-)

---

## Архитектура

- **3 бота** (`user_bot`, `mod_bot`, `admin_bot`)
- **одна общая база данных** (SQLAlchemy/MySQL)
- **Redis** — хранение FSM состояний (aiogram 3 storage)
- **Alembic** — миграции схемы базы

---

## Структура проекта

Пример структуры (ключевые файлы):
```
bot/
├── bots/
│   ├── admin_bot.py
│   ├── user_bot.py
│   ├── mod_bot.py
├── alembic/
│   ├── versions/
│   ├── env.py
├── app/
│   ├── bot/
│   │   ├── admin/
│   │   │   ├── router.py
│   │   │   ├── states.py
│   │   ├── common/
│   │   │   ├── filters.py
│   │   ├── user/
│   │   │   ├── router.py
│   │   │   ├── states.py
│   │   ├── mod/
│   │   │   ├── router.py
│   │   │   ├── states.py
│   ├── db/
│   │   ├── base.py
│   │   ├── models.py
│   │   ├──  session.py
│   ├── services/
│   │   ├── admin_queries.py
│   │   ├── bets.py
│   │   ├── events.py
│   │   ├── notify.py
│   │   ├── odds.py
│   │   ├── proposals.py
│   │   ├── support.py
│   │   ├── users.py
│   ├── config.py
├── requirements.txt
├── .env.example
├── alembic.ini
```

---

## Роли и доступы

Роль хранится в базе в поле `role`:

- `user` — доступ только к **User Bot**
- `moderator` — доступ к **Mod Bot**
- `admin` — полный доступ (Admin Bot + всё остальное)

Дополнительно переменная `ADMINS` в `.env` задаёт список tg_id, которым при первом `/start` выдаётся роль `admin`.

---

## Как работает тотализатор и коэффициенты

В проекте реализован **тотализатор (pari-mutuel)**, а не фиксированный букмекерский коэффициент.

### Принцип
- Все ставки формируют общий **пул** события.
- Пул распределяется между вариантами.
- Коэффициенты **динамические**: если на вариант ставят больше — его коэффициент падает, если меньше — растёт.
- При закрытии события выбирается победный вариант, вычисляется **финальный коэффициент**, и происходит выплата.

### Комиссия
У события есть комиссия `fee_percent` (например 5%).
Комиссия удерживается от общего пула перед выплатами.

### Формула финального коэффициента
Обозначения:
- `TOTAL` — общий пул по всем вариантам
- `POOL(option)` — сумма денег на конкретный вариант
- `FEE` — комиссия (например 0.05)

Финальный коэффициент:
`coeff(option) = TOTAL * (1 - FEE) / POOL(option)`

### Пример расчёта
Событие с 2 вариантами:
- A: на него поставили 100
- B: на него поставили 300
- TOTAL = 400
- FEE = 5% → (1 - FEE) = 0.95

Кэф(A) = 400 * 0.95 / 100 = 3.80  
Кэф(B) = 400 * 0.95 / 300 = 1.27  

Если победил A и пользователь ставил 50:
выплата = 50 * 3.80 = 190

> Важно: при выборе варианта пользователь видит “примерный кэф” (на текущий момент). Финальная выплата считается при закрытии события.

---

## Установка и запуск Linux (Fedora/Ubuntu)

### 1) Установить Redis
Fedora:
```bash
sudo dnf install -y redis
sudo systemctl enable --now redis
redis-cli ping
```

Ubuntu/Debian:
```bash
sudo apt update
sudo apt install -y redis-server
sudo systemctl enable --now redis-server
redis-cli ping
```

### 2) Подготовить Python окружение
```bash
python -m venv venv
source venv/bin/activate
pip install -U pip
pip install -r requirements.txt
```

### 3) Настроить .env
```bash
cp .env.example .env
```
Открой .env и заполни токены и доступы к БД/Redis.

### 4) Прогнать миграции
```bash
alembic revision --autogenerate -m "init"
alembic upgrade head
```

## Установка и запуск Windows
### 1) Установить Redis
```bash
docker run -d --name redis -p 6379:6379 redis:7
```

### 2) Подготовить Python окружение
```bash
python -m venv venv
venv\Scripts\activate
pip install -U pip
pip install -r requirements.txt
```

### 3) Настроить .env
```bash
copy .env.example .env
```
Открой .env и заполни токены и доступы к БД/Redis.

### 4) Прогнать миграции
```bash
alembic revision --autogenerate -m "init"
alembic upgrade head
```

## Настройка .env
Файл .env НЕ коммитится. В репозитории есть .env.example.

```
# Telegram tokens
USER_BOT_TOKEN=PUT_TOKEN_HERE
MOD_BOT_TOKEN=PUT_TOKEN_HERE
ADMIN_BOT_TOKEN=PUT_TOKEN_HERE

# Database (MySQL)
DB_HOST=localhost
DB_PORT=3306
DB_NAME=toto
DB_USER=toto_user
DB_PASSWORD=secret

# Redis
REDIS_URL_USER=redis://localhost:6379/0
REDIS_URL_MOD=redis://localhost:6379/1
REDIS_URL_ADMIN=redis://localhost:6379/2

# Admins & Moderators (telegram ids, comma-separated)
ADMINS=123456789,987654321
MODERATORS=123456789,987654321
```


## Команды запуска бота
### Linux
```
python -m bots.user_bot
python -m bots.mod_bot
python -m bots.admin_bot
```

### Windows:
```
python -m bots.user_bot
python -m bots.mod_bot
python -m bots.admin_bot
```

# Тестовый сценарий проверки
1.Запустить Redis
2.Запустить все 3 бота
3.В user bot: /start → баланс 1000
4.В admin bot: создать событие (варианты, комиссия)
5.В user bot: открыть событие → поставить ставку
6.В admin bot: закрыть событие (выбрать победителя)
7.Проверить:
    пользователю пришло уведомление
    ставка стала won/lost
    баланс обновился
8.Поддержка:
    user bot: создать тикет и написать сообщение
    mod bot: ответить и закрыть тикет
    user bot: убедиться, что после закрытия тикета новые сообщения не пересылаются

# Известные ограничения / баги
Телеграм ограничивает длину сообщений (4096 символов) — длинные диалоги/логи могут делиться на части.
Если пользователь закрыл личные сообщения боту — уведомления могут не доставляться.
Коэффициент, который показывает user bot до ставки — ориентировочный, финальный считается при закрытии.
При высокой нагрузке стоит добавить очереди задач (Redis Streams / Celery / RQ) и вынести расчёты/уведомления.

## Ошибки и их исправления
### 1 ) No module named app
Запускай из корня:
```
python -m bots.user_bot
```
и убедись что есть app/__init__.py.

### 2 ) Redis connection error
Проверь что Redis запущен:
```
redis-cli ping
```
